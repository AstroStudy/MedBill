<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ganesh Billing Solutions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #2c7a5a;
            --secondary: #3daa7d;
            --light: #f0f7f4;
            --dark: #1e3f34;
            --accent: #ff6b35;
            --border: #d1e5dc;
        }

        body {
            background: linear-gradient(135deg, #f0f7f4 0%, #e1f0e9 100%);
            min-height: 100vh;
            display: flex;
            color: var(--dark);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Navigation sidebar */
        .sidebar {
            width: 200px;
            background: var(--dark);
            color: white;
            padding: 20px 0;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .logo-container {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .logo {
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .logo-sub {
            font-size: 12px;
            opacity: 0.8;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            margin: 5px 10px;
            background: transparent;
            color: rgba(255,255,255,0.8);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-btn i {
            margin-right: 12px;
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Main content area */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Common styles for containers */
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .invoice-container {
            width: 8.27in;
            min-height: 5.83in;
            height: auto;
            margin: 0 auto;
            padding: 15px;
            border: 1px solid var(--border);
            box-sizing: border-box;
            page-break-after: avoid;
            page-break-inside: avoid;
            font-size: 12px;
        }

        /* Invoice Header */
        .invoice-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            gap: 10px;
        }

        .vendor-info {
            width: 60%;
            font-size: 11px;
            line-height: 1.4;
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 8px;
        }

        .vendor-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .invoice-meta {
            width: 35%;
            text-align: right;
            font-size: 11px;
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 8px;
        }

        .invoice-title {
            text-align: center;
            font-size: 8px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            padding: 4px;
            background: rgba(61, 170, 125, 0.1);
            border-radius: 5px;
        }

        /* Customer Details - New Compact Layout */
        .customer-details-section {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .customer-box {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 8px;
            font-size: 11px;
        }

        .customer-box-header {
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary);
            font-size: 8px;
        }

        .customer-inputs {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .customer-inputs input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 11px;
        }

        .invoice-info-box {
            width: 100%; /* Changed to 100% to take full width */
            display: flex;
            border: 1px solid var(--border);
            align-items: center;
            gap: 20px;
            border-radius: 5px;
            padding: 8px;
            flex-wrap: wrap;
            font-size: 11px;
        }

        /* Medicine Table */
        .medicine-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10px;
            table-layout: fixed;
        }

        .medicine-table th {
            background: var(--primary);
            color: white;
            padding: 5px 3px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
        }

        .medicine-table td {
            padding: 5px 3px;
            border-bottom: 1px solid var(--border);
            font-size: 10px;
            height: 25px;
        }

        .medicine-table input {
            width: 100%;
            padding: 3px;
            border: none;
            background: transparent;
            font-size: 10px;
        }

        .medicine-table select {
            width: 100%;
            padding: 3px;
            border: 1px solid var(--border);
            border-radius: 3px;
            background: white;
            font-size: 10px;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-remove {
            background: #e74c3c;
            padding: 3px 8px;
            font-size: 10px;
        }

        .btn-remove:hover {
            background: #c0392b;
        }

        /* Totals and Payment */
        .totals-section {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }

        .payment-info {
            width: 60%;
        }

        .payment-mode {
            font-size: 11px;
            margin-bottom: 8px;
        }

        .payment-mode select {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 10px;
        }

        .bank-details {
            margin-top: 8px;
            padding: 8px;
            background: rgba(240, 247, 244, 0.5);
            border-radius: 5px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            line-height: 1.4;
        }

        .bank-info {
            flex: 1;
        }

        .qr-code {
            width: 70px;
            height: 70px;
            background: #f8f8f8;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 5px;
            margin-left: 10px;
        }

        .qr-code img { /* Added style for the image */
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .qr-code-placeholder {
            color: #999;
            text-align: center;
            padding: 5px;
            font-size: 8px;
        }

        .totals {
            width: 35%;
        }

        .totals table {
            width: 100%;
            font-size: 10px;
        }

        .totals td {
            padding: 4px 0;
        }

        .totals tr:last-child td {
            font-weight: 700;
            font-size: 10px;
            border-top: 2px solid var(--border);
            padding-top: 6px;
        }

        /* Footer */
        .invoice-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 10px;
            line-height: 1.4;
        }

        .declaration {
            width: 70%;
        }

        .declaration ul {
            margin-top: 3px;
            padding-left: 15px;
            font-size: 9px;
        }

        .signature {
            width: 25%;
            text-align: center;
        }

        .signature-line {
            border-top: 1px solid var(--dark);
            width: 100%;
            margin: 15px auto 3px;
        }

        /* Purchases Form */
        .purchase-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark);
            font-size: 13px;
        }

        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 13px;
        }

        /* Report Section */
        .report-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .date-filter {
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--light);
            padding: 8px 12px;
            border-radius: 5px;
            flex: 1;
        }

        .date-filter label {
            font-weight: 600;
            white-space: nowrap;
            font-size: 13px;
        }

        .date-filter input {
            padding: 7px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
        }

        .report-actions {
            display: flex;
            gap: 8px;
        }

        .btn-print {
            background: #3498db;
        }

        .btn-csv {
            background: #27ae60;
        }

        .report-type-selector {
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .report-type-selector label {
            margin-right: 15px;
            font-weight: 600;
            font-size: 13px;
        }

        /* Column widths for perfect fit */
        .col-no { width: 4%; }
        .col-name { width: 22%; }
        .col-mfr { width: 8%; }
        .col-hsn { width: 8%; }
        .col-batch { width: 9%; }
        .col-expiry { width: 8%; }
        .col-qty { width: 5%; }
        .col-rate { width: 8%; }
        .col-disc { width: 7%; }
        .col-gst { width: 8%; }
        .col-amount { width: 10%; }
        .col-action { width: 3%; }

        /* Print specific styles */
        @media print {
            body {
                padding: 0;
                margin: 0;
                background: white;
                font-size: 10px;
            }
            
            @page {
                margin: 0;
            }

            .sidebar, .header-bar, .btn-add, .btn-remove, .no-print, #messageModal {
                display: none !important;
            }
            
            .main-content {
                padding: 0;
            }
            
            .invoice-container {
                border: none;
                box-shadow: none;
                width: 100%;
                min-height: auto;
                padding: 0;
                transform: none;
                transform-origin: top left;
                font-size: 9px;
                page-break-inside: avoid;
            }
            
            .btn {
                display: none;
            }
            
            .medicine-table {
                font-size: 8px;
            }
            
            .medicine-table th, .medicine-table td {
                padding: 3px 2px;
            }
            
            .medicine-table input, .medicine-table select {
                font-size: 8px;
                padding: 1px;
            }
            
            .invoice-title {
                font-size: 12px;
            }
            
            .vendor-info, .invoice-meta {
                font-size: 9px;
            }
            
            .customer-box-header {
                font-size: 9px;
            }
            
            .bank-details {
                font-size: 8px;
            }
            
            .totals table {
                font-size: 9px;
            }
            
            .declaration {
                font-size: 8px;
            }
            
            .declaration ul {
                font-size: 7px;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .sidebar {
                width: 180px;
            }
            
            .invoice-container {
                width: 100%;
                padding: 15px;
            }
        }

        @media (max-width: 992px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 10px;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .logo-container {
                width: 100%;
                text-align: center;
                padding: 10px;
            }
            
            .nav-btn {
                margin: 5px;
                padding: 8px 15px;
                font-size: 13px;
            }
            
            .nav-btn i {
                margin-right: 5px;
            }
        }

        @media (max-width: 768px) {
            .customer-details-section {
                flex-direction: column;
            }
            
            .customer-box, .invoice-info-box {
                width: 100%;
            }
            
            .purchase-form {
                grid-template-columns: 1fr;
            }
            
            .report-controls {
                flex-direction: column;
            }
            
            .medicine-table {
                font-size: 9px;
            }
            
            .col-name { width: 18%; }
            .col-mfr { width: 7%; }
            
            .bank-details {
                flex-direction: row;
            }
            
            .qr-code {
                margin: 8px 0 0 0; margin-left: 10px !important;margin-top: 0 !important;
                align-self: flex-start;
            }
        }
        
        /* New report styles */
        .report-total {
            margin-top: 15px;
            padding: 10px;
            background: rgba(61, 170, 125, 0.1);
            border-radius: 5px;
            font-weight: bold;
            text-align: right;
            font-size: 16px;
        }
        
        .date-filter.stock {
            display: none;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .report-title {
            font-size: 18px;
            color: var(--primary);
            font-weight: 600;
        }

        /* Data Management Styles */
        .data-management-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-management-section {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .data-management-section h3 {
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .danger-zone {
            border: 2px solid #e74c3c;
            background-color: rgba(231, 76, 60, 0.05);
        }

        .danger-zone h3 {
            color: #e74c3c;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .form-row {
            margin-bottom: 12px;
        }

        .form-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
        }

        .form-row input, 
        .form-row select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
        }

        /* Custom Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            text-align: center;
        }

        .modal-header {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .modal-body {
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .modal-footer button {
            background-color: var(--primary);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: background-color 0.3s ease;
        }

        .modal-footer button:hover {
            background-color: var(--secondary);
        }

        .modal-footer .cancel-btn {
            background-color: #e74c3c;
        }

        .modal-footer .cancel-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo">GANESH </div>
            <div class="logo-sub">Billing Solutions</div>
        </div>
        <button class="nav-btn active" onclick="showPage('invoice')">
            <i class="fas fa-file-invoice"></i> Invoice
        </button>
        <button class="nav-btn" onclick="showPage('purchases')">
            <i class="fas fa-cart-plus"></i> Purchases
        </button>
        <button class="nav-btn" onclick="showPage('report')">
            <i class="fas fa-chart-bar"></i> Reports
        </button>
        <button class="nav-btn" onclick="showPage('data-management')">
            <i class="fas fa-database"></i> Data Management
        </button>
    </div>
    
    <div class="main-content">
        <div class="header-bar">
            <div class="page-title" id="current-page-title">Tax Invoice</div>
        </div>
            
        <div id="invoice-page" class="page-content">
            <div class="container invoice-container">
                <div class="invoice-title"> ||<<<<< MEDICAL BILL >>>>>||<<<<< TAX INVOICE >>>>>|| GANESH BILLING SOLUTIONS : ravikishoreca@gmail.com ||</div>
                
                <div class="invoice-header">    
                    <div class="vendor-info" style="width: 40%">
                        <div class="vendor-name">City Medical Store</div>
                        <div>123 Health Street, Medical Town - 400001</div>
                        <div>GSTIN: 22ABCDE1234F1Z5 | DL No: DL-1234/R/2020</div>
                        <div>Phone: 9876543210 | Email: info@citymedicals.com</div>
                    </div>
                    <div class="customer-box">
                        <div class="customer-box-header">CUSTOMER DETAILS</div>
                        <div class="customer-inputs">
                            <input type="text" id="customer-name" placeholder="Customer Name">
                            <input type="text" id="customer-address" placeholder="Address (optional)">
                        </div>
                    </div>
                    <div class="invoice-info-box" style="width: 100%; text-align: center;">
                        <div class="customer-box-header">BILLING INFORMATION</div>
                        <div><strong>Bill No:</strong> <span id="invoice-bill-no">MED2023-001</span></div>
                        <div><strong>Date:</strong> <span id="invoice-date2">01/04/2023</span></div>
                        <div><strong>Time:</strong> <span id="invoice-time">10:45 AM</span></div>
                    </div>                   
                </div>

                <div class="action-buttons" style="height: 60%">
                    <button class="btn btn-add" onclick="addNewRow()">
                        <i class="fas fa-plus"></i> Add Medicine
                    </button>
                </div>
                <table class="medicine-table">
                    <thead>
                        <tr>
                            <th class="col-no">No</th>
                            <th class="col-name">Medicine Name</th>
                            <th class="col-mfr">MFR</th>
                            <th class="col-hsn">HSN</th>
                            <th class="col-batch">Batch</th>
                            <th class="col-expiry">Expiry</th>
                            <th class="col-qty">Qty</th>
                            <th class="col-rate">Rate</th>
                            <th class="col-disc">Disc.</th>
                            <th class="col-gst">GST</th>
                            <th class="col-amount">Amount</th>
                            <th class="col-action no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="medicine-table-body">
                        <tr class="medicine-row">
                            <td class="col-no">1</td>
                            <td class="col-name"><input type="text" class="medicine-name" placeholder="Medicine name"></td>
                            <td class="col-mfr"><input type="text" class="mfr-code" placeholder="MFR" maxlength="4" readonly></td>
                            <td class="col-hsn"><input type="text" class="hsn-code" placeholder="HSN" maxlength="8" readonly></td>
                            <td class="col-batch"><input type="text" class="batch-no" placeholder="Batch" readonly></td>
                            <td class="col-expiry"><input type="text" class="expiry" placeholder="MM/YY" readonly></td>
                            <td class="col-qty"><input type="number" class="quantity" placeholder="Qty" min="1"></td>
                            <td class="col-rate"><input type="text" class="rate" placeholder="Rate" readonly></td>
                            <td class="col-disc"><input type="text" class="discount" value="0" readonly></td>
                            <td class="col-gst">
                                <select class="gst-rate" disabled>
                                    <option>5%</option>
                                    <option>12%</option>
                                    <option selected>18%</option>
                                </select>
                            </td>
                            <td class="col-amount amount">0.00</td>
                            <td class="col-action no-print"><button class="btn btn-remove" onclick="removeRow(this)"><i class="fas fa-times"></i></button></td>
                        </tr>
                        <tr class="medicine-row">
                            <td class="col-no">2</td>
                            <td class="col-name"><input type="text" class="medicine-name" placeholder="Medicine name"></td>
                            <td class="col-mfr"><input type="text" class="mfr-code" placeholder="MFR" maxlength="4" readonly></td>
                            <td class="col-hsn"><input type="text" class="hsn-code" placeholder="HSN" maxlength="8" readonly></td>
                            <td class="col-batch"><input type="text" class="batch-no" placeholder="Batch" readonly></td>
                            <td class="col-expiry"><input type="text" class="expiry" placeholder="MM/YY" readonly></td>
                            <td class="col-qty"><input type="number" class="quantity" placeholder="Qty" min="1"></td>
                            <td class="col-rate"><input type="text" class="rate" placeholder="Rate" readonly></td>
                            <td class="col-disc"><input type="text" class="discount" value="0" readonly></td>
                            <td class="col-gst">
                                <select class="gst-rate" disabled>
                                    <option>5%</option>
                                    <option selected>12%</option>
                                    <option>18%</option>
                                </select>
                            </td>
                            <td class="col-amount amount">0.00</td>
                            <td class="col-action no-print"><button class="btn btn-remove" onclick="removeRow(this)"><i class="fas fa-times"></i></button></td>
                        </tr>
                    </tbody>
                </table>

                <div class="totals-section">
                    <div class="payment-info">
                        <div class="payment-mode">
                            <strong>Payment Mode:</strong> 
                            <select id="payment-mode">
                                <option>Cash</option>
                                <option>Card</option>
                                <option>UPI</option>
                                <option>Wallet</option>
                                <option>Credit</option>
                            </select>
                        </div>
                        <div class="bank-details">
                            <div class="bank-info">
                                <strong>Bank Details:</strong>
                                <div>Bank: State Bank of India</div>
                                <div>A/C Name: City Medical Store</div>
                                <div>A/C No.: 1234567890</div>
                                <div>IFSC: SBIN0000123</div>
                                <div>UPI: citymedicals@upi</div>
                            </div>
                            <div class="qr-code">
                              <img src="https://placehold.co/70x70/E0E0E0/333333?text=QR" alt="QR Code for Payment">
                            </div>
                        </div>
                    </div>
                    <div class="totals">
                        <table>
                            <tr>
                                <td><strong>Subtotal:</strong></td>
                                <td id="subtotal">0.00</td>
                            </tr>
                            <tr>
                                <td><strong>Discount:</strong></td>
                                <td id="total-discount">0.00</td>
                            </tr>
                            <tr>
                                <td><strong>CGST:</strong></td>
                                <td id="cgst">0.00</td>
                            </tr>
                            <tr>
                                <td><strong>SGST:</strong></td>
                                <td id="sgst">0.00</td>
                            </tr>
                            <tr>
                                <td><strong>IGST:</strong></td>
                                <td id="igst">0.00</td>
                            </tr>
                            <tr>
                                <td><strong>Total:</strong></td>
                                <td id="total">₹0.00</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="invoice-footer">
                    <div class="declaration">
                        <strong>Declaration:</strong> 
                        <ul>
                            <li> All medicines sold as per doctor's prescription only and once sold will not be taken back or exchanged</li>
                            <li>Please check expiry date before using medicines and keep medicines out of reach of children</li>
                        </ul>
                    </div>
                    <div class="signature">
                        <div>For <strong>City Medical Store</strong></div>
                        <div class="signature-line"></div>
                        <div>Authorized Signatory</div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 15px; justify-content: center; gap: 20px;">
                <button class="btn" onclick="window.print()" style="background: #27ae60; ">
                    <i class="fas fa-print"></i> Print Invoice
                </button>
                <button class="btn" onclick="saveSales()" style="background: #27ae60;">
                    <i class="fas fa-save"></i> Save Invoice
                </button>
                <button class="btn" onclick="printAndSaveSales()" style="background: #22a1e6;">
                    <i class="fas fa-print"></i> Print & Save
                </button>
            </div>
        </div>
        
        <div id="purchases-page" class="page-content" style="display: none;">
            <div class="container">
                <h2 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-cart-plus"></i> Purchase Entry
                </h2>
                
                <div class="purchase-form">
                    <div class="form-group">
                        <label>Vendor Name</label>
                        <input type="text" id="vendor-name" placeholder="Enter vendor name">
                    </div>
                    <div class="form-group">
                        <label>Vendor GSTIN</label>
                        <input type="text" id="vendor-gstin" placeholder="Enter GSTIN">
                    </div>
                    <div class="form-group">
                        <label>Vendor Address</label>
                        <input type="text" id="vendor-address" placeholder="Enter address">
                    </div>
                    <div class="form-group">
                        <label>Invoice Date</label>
                        <input type="date" id="purchase-date">
                    </div>
                    <div class="form-group">
                        <label>Invoice Number</label>
                        <input type="text" id="purchase-invoice" placeholder="Enter invoice number">
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="payment-terms">
                            <option>Immediate Payment</option>
                            <option>7 Days</option>
                            <option>15 Days</option>
                            <option>30 Days</option>
                        </select>
                    </div>
                </div>
                
                <div class="section-title">MEDICINE DETAILS</div>
                <div class="action-buttons">
                    <button class="btn btn-add" onclick="addPurchaseRow()">
                        <i class="fas fa-plus"></i> Add Medicine
                    </button>
                </div>
                
                <table class="medicine-table">
                    <thead>
                        <tr>
                            <th class="col-no">No</th>
                            <th class="col-name">Medicine Name</th>
                            <th class="col-mfr">MFR</th>
                            <th class="col-hsn">HSN</th>
                            <th class="col-batch">Batch</th>
                            <th class="col-expiry">Expiry</th>
                            <th class="col-qty">Qty</th>
                            <th class="col-rate">Rate</th>
                            <th class="col-disc">Disc.</th>
                            <th class="col-gst">GST</th>
                            <th class="col-amount">Amount</th>
                            <th class="col-action no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="purchase-table-body">
                        <tr class="medicine-row">
                            <td class="col-no">1</td>
                            <td class="col-name"><input type="text" class="medicine-name" placeholder="Medicine name"></td>
                            <td class="col-mfr"><input type="text" class="mfr-code" placeholder="MFR"></td>
                            <td class="col-hsn"><input type="text" class="hsn-code" placeholder="HSN"></td>
                            <td class="col-batch"><input type="text" class="batch-no" placeholder="Batch"></td>
                            <td class="col-expiry"><input type="text" class="expiry" placeholder="MM/YY"></td>
                            <td class="col-qty"><input type="number" class="quantity" placeholder="Qty" min="1"></td>
                            <td class="col-rate"><input type="text" class="rate" placeholder="Rate"></td>
                            <td class="col-disc"><input type="text" class="discount" value="0"></td>
                            <td class="col-gst">
                                <select class="gst-rate">
                                    <option>5%</option>
                                    <option>12%</option>
                                    <option selected>18%</option>
                                </select>
                            </td>
                            <td class="col-amount amount">0.00</td>
                            <td class="col-action no-print"><button class="btn btn-remove" onclick="removePurchaseRow(this)"><i class="fas fa-times"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="action-buttons" style="margin-top: 15px; gap: 20px;" >
                    <button class="btn" style="background: #9b59b6;">
                        <i class="fas fa-file-invoice"></i> View Invoice
                    </button>
                    <button class="btn" onclick="savePurchase()" style="background: #27ae60;">
                        <i class="fas fa-save"></i> Save Purchase
                    </button>
                    <button class="btn" style="background: #e67e22;">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn" onclick="printAndSavePurchase()" style="background: #22a1e6;">
                        <i class="fas fa-print"></i> Print & Save
                    </button>
                </div>
            </div>
        </div>
        
        <div id="report-page" class="page-content" style="display: none;">
            <div class="container">
                <div class="report-header">
                    <div class="report-title" id="current-report-title">Reports</div>
                </div>
                
                <div class="report-type-selector">
                    <label>
                        <input type="radio" name="report-type" value="sales" checked onchange="showReportType()"> Sales
                    </label>
                    <label>
                        <input type="radio" name="report-type" value="purchases" onchange="showReportType()"> Purchases
                    </label>
                    <label>
                        <input type="radio" name="report-type" value="stock" onchange="showReportType()"> Stock Report
                    </label>
                </div>
                
                <div class="report-controls">
                    <div class="date-filter" id="date-range-filter">
                        <label>From Date:</label>
                        <input type="date" id="report-from">
                        <label>To Date:</label>
                        <input type="date" id="report-to">
                    </div>
                    
                    <div class="date-filter stock" id="stock-date-filter">
                        <label>As of Date:</label>
                        <input type="date" id="report-stock-date">
                    </div>
                    
                    <div class="report-actions">
                        <button class="btn btn-print" onclick="printReport()">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                        <button class="btn btn-csv" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i> Export to CSV
                        </button>
                    </div>
                </div>
                
                <div class="report-total" id="report-total-value">
                    Total Value: ₹0.00
                </div>
                
                <table class="medicine-table">
                    <thead>
                        <tr id="report-head">
                            </tr>
                    </thead>
                    <tbody id="report-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="data-management-page" class="page-content" style="display: none;">
            <div class="container">
                <h2 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-database"></i> Data Management
                </h2>
                
                <div class="data-management-form">
                    <div class="data-management-section">
                        <h3><i class="fas fa-trash-alt"></i> Delete Transactions</h3>
                        
                        <div class="form-row">
                            <label>Delete by Invoice Number</label>
                            <div style="display: flex; gap: 8px;">
                                <select id="delete-transaction-type" style="flex: 1;">
                                    <option value="sale">Sale Invoice</option>
                                    <option value="purchase">Purchase Invoice</option>
                                </select>
                                <input type="text" id="delete-invoice-number" placeholder="Enter invoice number" style="flex: 2;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-danger" onclick="confirmDeleteByInvoice()" style="width: 100%;">
                                <i class="fas fa-trash"></i> Delete Invoice
                            </button>
                        </div>
                        
                        <div class="form-row">
                            <label>Delete Transactions Between Dates</label>
                            <div style="display: flex; gap: 8px;">
                                <select id="delete-date-type" style="flex: 1;">
                                    <option value="sale">Sales</option>
                                    <option value="purchase">Purchases</option>
                                    <option value="both">Both</option>
                                </select>
                                <input type="date" id="delete-from-date" style="flex: 1;">
                                <input type="date" id="delete-to-date" style="flex: 1;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-danger" onclick="confirmDeleteByDateRange()" style="width: 100%;">
                                <i class="fas fa-trash"></i> Delete Transactions
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-management-section danger-zone">
                        <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                        
                        <div class="form-row">
                            <label>Delete All Transaction Data</label>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                This will permanently delete ALL sales and purchase transactions. This action cannot be undone.
                            </p>
                            <input type="password" id="admin-password" placeholder="Enter admin password">
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-danger" onclick="confirmDeleteAll()" style="width: 100%;">
                                <i class="fas fa-skull-crossbones"></i> Delete All Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="data-management-section" style="margin-top: 20px;">
                    <h3><i class="fas fa-file-export"></i> Backup & Restore</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div class="form-row">
                                <label>Create Backup</label>
                                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                    Download a backup of all your data.
                                </p>
                                <button class="btn" onclick="createBackupFile()" style="width: 100%;">
                                    <i class="fas fa-file-download"></i> Download Backup
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-row">
                                <label>Restore from Backup (Upload a previously saved backup file.)</label>

                                <input type="file" id="backup-file" accept=".json" style="margin-bottom: 8px; width: 50%;">
                                <button class="btn" onclick="restoreBackupFile()" style="width: 30%;">
                                    <i class="fas fa-file-upload"></i> Restore Backup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter">
                <button onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Placeholder for Google Apps Script Web App URL
        // IMPORTANT: Replace 'YOUR_WEB_APP_URL_HERE' with the actual URL after deploying your Apps Script
        const GOOGLE_APPS_SCRIPT_URL = https://docs.google.com/spreadsheets/d/1rqst-Yi72dkC7ndfS9Y7uyB00duNlZaW8-oThsJL8cA/edit?gid=1469024108#gid=1469024108;

        // Function to show custom modal messages
        function showMessage(header, body, type = 'alert', callback = null) {
            document.getElementById('modalHeader').textContent = header;
            document.getElementById('modalBody').textContent = body;
            const modalFooter = document.getElementById('modalFooter');
            modalFooter.innerHTML = ''; // Clear previous buttons

            if (type === 'confirm') {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirm';
                confirmBtn.onclick = () => {
                    closeModal();
                    if (callback) callback(true);
                };
                modalFooter.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'cancel-btn';
                cancelBtn.onclick = () => {
                    closeModal();
                    if (callback) callback(false);
                };
                modalFooter.appendChild(cancelBtn);
            } else { // 'alert' type
                const okBtn = document.createElement('button');
                okBtn.textContent = 'OK';
                okBtn.onclick = () => {
                    closeModal();
                    if (callback) callback();
                };
                modalFooter.appendChild(okBtn);
            }
            document.getElementById('messageModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // Initialize with 2 rows
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date and time for invoice
            const today = new Date();
            const formattedDate = today.toLocaleDateString('en-GB');
            const formattedTime = today.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            document.getElementById('invoice-date2').textContent = formattedDate;
            document.getElementById('invoice-time').textContent = formattedTime;
            
            // Set default dates for purchases and reports
            document.getElementById('purchase-date').valueAsDate = today;
            document.getElementById('report-from').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('report-to').valueAsDate = today;
            document.getElementById('report-stock-date').valueAsDate = today;
            
            // Set default dates for delete operations
            document.getElementById('delete-from-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('delete-to-date').valueAsDate = today;
            
            // Add event listeners to initial rows
            document.querySelectorAll('#medicine-table-body .quantity, #medicine-table-body .rate, #medicine-table-body .discount').forEach(input => {
                input.addEventListener('input', calculateRow);
            });

            document.querySelectorAll('#medicine-table-body .gst-rate').forEach(select => {
                select.addEventListener('change', calculateRow);
            });

            document.querySelectorAll('#medicine-table-body .medicine-name').forEach(input => {
                input.addEventListener('blur', function() {
                    if(this.value) {
                        searchMedicineInStock(this);
                    }
                });
            });

            document.querySelectorAll('#medicine-table-body .quantity').forEach(input => {
                input.addEventListener('input', function() {
                    validateQuantity(this);
                });
            });
            
            // Add event listeners to report date filters
            document.getElementById('report-from').addEventListener('change', generateReport);
            document.getElementById('report-to').addEventListener('change', generateReport);
            document.getElementById('report-stock-date').addEventListener('change', generateReport);

            // Initial calculation for existing rows
            document.querySelectorAll('#medicine-table-body .medicine-row').forEach(row => {
                const quantityInput = row.querySelector('.quantity');
                const rateInput = row.querySelector('.rate');
                const discountInput = row.querySelector('.discount');
                const gstSelect = row.querySelector('.gst-rate');

                if (quantityInput && rateInput && discountInput && gstSelect) {
                    quantityInput.addEventListener('input', calculateRow);
                    rateInput.addEventListener('input', calculateRow);
                    discountInput.addEventListener('input', calculateRow);
                    gstSelect.addEventListener('change', calculateRow);
                }
            });
            calculateTotals();
        });

        // Show/hide pages based on navigation
        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected page
            document.getElementById(page + '-page').style.display = 'block';
            
            // Update active button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active'); // Use event.target to get the clicked button
            
            // Update page title
            const titles = {
                'invoice': 'Tax Invoice',
                'purchases': 'Purchase Entry',
                'report': 'Reports',
                'data-management': 'Data Management'
            };
            document.getElementById('current-page-title').textContent = titles[page];
            
            // If showing report page, set initial state
            if (page === 'report') {
                showReportType();
            }
        }
        
        function showReportType() {
            const reportType = document.querySelector('input[name="report-type"]:checked').value;
            const dateRangeFilter = document.getElementById('date-range-filter');
            const stockDateFilter = document.getElementById('stock-date-filter');
            
            // Update report title
            const titles = {
                'sales': 'Sales Report',
                'purchases': 'Purchases Report',
                'stock': 'Stock Report'
            };
            document.getElementById('current-report-title').textContent = titles[reportType];
            
            // Show/hide date filters
            if (reportType === 'stock') {
                dateRangeFilter.style.display = 'none';
                stockDateFilter.style.display = 'flex';
            } else {
                dateRangeFilter.style.display = 'flex';
                stockDateFilter.style.display = 'none';
            }
            
            // Generate the report
            generateReport();
        }

        function calculateRow(e) {
            const row = e.target.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const discount = parseFloat(row.querySelector('.discount').value) || 0;
            const gstRate = parseFloat(row.querySelector('.gst-rate').value) / 100 || 0;
            
            const amountBeforeGST = (quantity * rate) - discount;
            const gstAmount = amountBeforeGST * gstRate;
            const totalAmount = amountBeforeGST + gstAmount;

            row.querySelector('.amount').textContent = totalAmount.toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            let totalGst = 0;
            
            document.querySelectorAll('#medicine-table-body .medicine-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const rate = parseFloat(row.querySelector('.rate').value) || 0;
                const discount = parseFloat(row.querySelector('.discount').value) || 0;
                const gstRate = parseFloat(row.querySelector('.gst-rate').value) / 100 || 0;

                const rowSubtotal = quantity * rate;
                const rowDiscount = discount;
                const amountBeforeGST = rowSubtotal - rowDiscount;
                const rowGST = amountBeforeGST * gstRate;

                subtotal += rowSubtotal;
                totalDiscount += rowDiscount;
                totalGst += rowGST;
            });
            
            document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
            document.getElementById('total-discount').textContent = '₹' + totalDiscount.toFixed(2);
            document.getElementById('cgst').textContent = '₹' + (totalGst / 2).toFixed(2);
            document.getElementById('sgst').textContent = '₹' + (totalGst / 2).toFixed(2);
            document.getElementById('igst').textContent = '₹0.00'; // Assuming no IGST for simplicity
            document.getElementById('total').textContent = '₹' + (subtotal - totalDiscount + totalGst).toFixed(2);
        }

        function addNewRow() {
            const tbody = document.getElementById('medicine-table-body');
            const newRow = document.querySelector('.medicine-row').cloneNode(true);
            const rowNum = tbody.children.length + 1;
            
            // Clear all inputs in the new row
            newRow.querySelector('td:first-child').textContent = rowNum;
            newRow.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.removeAttribute('data-available-qty'); // Clear available quantity
            });
            newRow.querySelector('.discount').value = '0';
            newRow.querySelector('.amount').textContent = '0.00';
            newRow.querySelector('.gst-rate').selectedIndex = 0;
            newRow.querySelector('.mfr-code').readOnly = true;
            newRow.querySelector('.hsn-code').readOnly = true;
            newRow.querySelector('.batch-no').readOnly = true;
            newRow.querySelector('.expiry').readOnly = true;
            newRow.querySelector('.rate').readOnly = true;
            newRow.querySelector('.discount').readOnly = true;
            newRow.querySelector('.gst-rate').disabled = true;

            tbody.appendChild(newRow);
            
            // Add event listeners to new inputs
            newRow.querySelectorAll('.quantity, .rate, .discount').forEach(input => {
                input.addEventListener('input', calculateRow);
            });
            newRow.querySelector('.gst-rate').addEventListener('change', calculateRow);
            newRow.querySelector('.medicine-name').addEventListener('blur', function() {
                if(this.value) {
                    searchMedicineInStock(this);
                }
            });
            newRow.querySelector('.quantity').addEventListener('input', function() {
                validateQuantity(this);
            });
            
            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-remove';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function() { removeRow(this); };
            newRow.querySelector('.no-print').innerHTML = '';
            newRow.querySelector('.no-print').appendChild(removeBtn);
            
            // Focus on the medicine name field of the new row
            newRow.querySelector('.medicine-name').focus();
            calculateTotals(); // Recalculate totals after adding a new row
        }
        
        function addPurchaseRow() {
            const tbody = document.getElementById('purchase-table-body');
            const newRow = document.querySelector('#purchase-table-body .medicine-row').cloneNode(true);
            const rowNum = tbody.children.length + 1;
            
            // Clear all inputs in the new row
            newRow.querySelector('td:first-child').textContent = rowNum;
            newRow.querySelectorAll('input').forEach(input => input.value = '');
            newRow.querySelector('.discount').value = '0';
            newRow.querySelector('.amount').textContent = '0.00';
            newRow.querySelector('.gst-rate').selectedIndex = 0;
            
            tbody.appendChild(newRow);
            
            // Add event listeners to new inputs
            newRow.querySelectorAll('.quantity, .rate, .discount').forEach(input => {
                input.addEventListener('input', calculatePurchaseRow);
            });
            newRow.querySelector('.gst-rate').addEventListener('change', calculatePurchaseRow);
            
            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-remove';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function() { removePurchaseRow(this); };
            newRow.querySelector('.no-print').innerHTML = '';
            newRow.querySelector('.no-print').appendChild(removeBtn);
            
            // Focus on the medicine name field of the new row
            newRow.querySelector('.medicine-name').focus();
        }

        function calculatePurchaseRow(e) {
            const row = e.target.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const discount = parseFloat(row.querySelector('.discount').value) || 0;
            const gstRate = parseFloat(row.querySelector('.gst-rate').value) / 100 || 0;
            
            const amountBeforeGST = (quantity * rate) - discount;
            const gstAmount = amountBeforeGST * gstRate;
            const totalAmount = amountBeforeGST + gstAmount;

            row.querySelector('.amount').textContent = totalAmount.toFixed(2);
        }

        function removeRow(button) {
            const row = button.closest('tr');
            if (document.querySelectorAll('#medicine-table-body .medicine-row').length > 1) {
                row.remove();
                // Update row numbers
                document.querySelectorAll('#medicine-table-body tr').forEach((tr, index) => {
                    tr.querySelector('td:first-child').textContent = index + 1;
                });
                calculateTotals();
            } else {
                showMessage('Error', "You must have at least one medicine row.");
            }
        }
        
        function removePurchaseRow(button) {
            const row = button.closest('tr');
            if (document.querySelectorAll('#purchase-table-body .medicine-row').length > 1) {
                row.remove();
                // Update row numbers
                document.querySelectorAll('#purchase-table-body tr').forEach((tr, index) => {
                    tr.querySelector('td:first-child').textContent = index + 1;
                });
            } else {
                showMessage('Error', "You must have at least one medicine row.");
            }
        }
        
        // Google Apps Script Integration
        // This function will be called when the medicine name input loses focus
        function searchMedicineInStock(medicineNameInput) {
            const medicineName = medicineNameInput.value.trim();
            const row = medicineNameInput.closest('tr');
            
            if (medicineName === '') {
                // Clear related fields if medicine name is empty
                row.querySelector('.mfr-code').value = '';
                row.querySelector('.hsn-code').value = '';
                row.querySelector('.batch-no').value = '';
                row.querySelector('.expiry').value = '';
                row.querySelector('.quantity').value = '';
                row.querySelector('.rate').value = '';
                row.querySelector('.discount').value = '0';
                row.querySelector('.gst-rate').selectedIndex = 0;
                row.querySelector('.amount').textContent = '0.00';
                medicineNameInput.removeAttribute('data-available-qty'); // Clear available quantity
                calculateTotals();
                return;
            }

            // Use google.script.run to call the Apps Script function
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.error) {
                        showMessage('Medicine Search', result.error);
                        // Clear fields if medicine not found
                        row.querySelector('.mfr-code').value = '';
                        row.querySelector('.hsn-code').value = '';
                        row.querySelector('.batch-no').value = '';
                        row.querySelector('.expiry').value = '';
                        row.querySelector('.quantity').value = '';
                        row.querySelector('.rate').value = '';
                        row.querySelector('.discount').value = '0';
                        row.querySelector('.gst-rate').selectedIndex = 0;
                        row.querySelector('.amount').textContent = '0.00';
                        medicineNameInput.removeAttribute('data-available-qty');
                    } else {
                        row.querySelector('.mfr-code').value = result.mfr;
                        row.querySelector('.hsn-code').value = result.hsn;
                        row.querySelector('.batch-no').value = result.batch;
                        row.querySelector('.expiry').value = result.expiry;
                        // Set rate and discount from stock, but allow editing if needed (currently readonly)
                        row.querySelector('.rate').value = result.rate.toFixed(2);
                        row.querySelector('.discount').value = result.disc.toFixed(2);
                        // Set GST rate
                        const gstSelect = row.querySelector('.gst-rate');
                        for (let i = 0; i < gstSelect.options.length; i++) {
                            if (parseFloat(gstSelect.options[i].value) === result.gst) {
                                gstSelect.selectedIndex = i;
                                break;
                            }
                        }
                        medicineNameInput.setAttribute('data-available-qty', result.availableQty);
                        showMessage('Medicine Found', `${result.medicine} found. Available quantity: ${result.availableQty}`);
                        calculateRow({ target: row.querySelector('.quantity') }); // Recalculate row amount
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('Error', 'Failed to search medicine: ' + error.message);
                })
                .searchMedicine(medicineName);
        }

        function validateQuantity(quantityInput) {
            const row = quantityInput.closest('tr');
            const medicineNameInput = row.querySelector('.medicine-name');
            const availableQty = parseFloat(medicineNameInput.getAttribute('data-available-qty')) || 0;
            const enteredQty = parseFloat(quantityInput.value) || 0;

            if (enteredQty > availableQty) {
                showMessage('Quantity Warning', `Quantity entered (${enteredQty}) exceeds available stock (${availableQty}). Please enter a lower quantity.`, 'alert', () => {
                    quantityInput.value = availableQty; // Set to max available
                    calculateRow({ target: quantityInput });
                });
            } else if (enteredQty < 0) {
                showMessage('Invalid Quantity', 'Quantity cannot be negative. Setting to 0.', 'alert', () => {
                    quantityInput.value = 0;
                    calculateRow({ target: quantityInput });
                });
            }
            calculateRow({ target: quantityInput }); // Always recalculate after validation
        }

        function saveSales() {
            const customerName = document.getElementById('customer-name').value;
            const customerAddress = document.getElementById('customer-address').value;
            const invoiceNo = document.getElementById('invoice-bill-no').textContent;
            const invoiceDate = document.getElementById('invoice-date2').textContent;
            const invoiceTime = document.getElementById('invoice-time').textContent;
            const paymentMode = document.getElementById('payment-mode').value;

            const items = [];
            let allFieldsFilled = true;

            document.querySelectorAll('#medicine-table-body .medicine-row').forEach(row => {
                const medicineName = row.querySelector('.medicine-name').value.trim();
                const qty = parseFloat(row.querySelector('.quantity').value) || 0;
                const rate = parseFloat(row.querySelector('.rate').value) || 0;
                const disc = parseFloat(row.querySelector('.discount').value) || 0;
                const gst = parseFloat(row.querySelector('.gst-rate').value) || 0;
                const amount = parseFloat(row.querySelector('.amount').textContent) || 0;
                const mfr = row.querySelector('.mfr-code').value.trim();
                const hsn = row.querySelector('.hsn-code').value.trim();
                const batch = row.querySelector('.batch-no').value.trim();
                const expiry = row.querySelector('.expiry').value.trim();

                if (!medicineName || qty <= 0 || rate <= 0) {
                    allFieldsFilled = false;
                    return;
                }

                // Calculate CGST, SGST, IGST based on the total amount for the item
                const amountBeforeGST = (qty * rate) - disc;
                const gstAmount = amountBeforeGST * (gst / 100);
                const cgst = gstAmount / 2;
                const sgst = gstAmount / 2;
                const igst = 0; // Assuming no IGST for local sales

                items.push({
                    medicineName, qty, rate, disc, gst, amount, mfr, hsn, batch, expiry, cgst, sgst, igst
                });
            });

            if (!customerName || items.length === 0 || !allFieldsFilled) {
                showMessage('Validation Error', 'Please fill in customer name and all medicine details correctly.');
                return;
            }

            const salesData = {
                customerName, customerAddress, invoiceNo, date: invoiceDate, time: invoiceTime, paymentMode, items
            };

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showMessage('Success', response.message);
                        // Optionally clear form or reset invoice
                        resetInvoiceForm();
                    } else {
                        showMessage('Error', response.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('Error', 'Failed to save sales data: ' + error.message);
                })
                .saveSalesData(salesData);
        }

        function savePurchase() {
            const vendorName = document.getElementById('vendor-name').value;
            const vendorAddress = document.getElementById('vendor-address').value;
            const purchaseInvoice = document.getElementById('purchase-invoice').value;
            const purchaseDate = document.getElementById('purchase-date').value; //YYYY-MM-DD
            const paymentTerms = document.getElementById('payment-terms').value;
            const purchaseTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

            const items = [];
            let allFieldsFilled = true;

            document.querySelectorAll('#purchase-table-body .medicine-row').forEach(row => {
                const medicineName = row.querySelector('.medicine-name').value.trim();
                const qty = parseFloat(row.querySelector('.quantity').value) || 0;
                const rate = parseFloat(row.querySelector('.rate').value) || 0;
                const disc = parseFloat(row.querySelector('.discount').value) || 0;
                const gst = parseFloat(row.querySelector('.gst-rate').value) || 0;
                const amount = parseFloat(row.querySelector('.amount').textContent) || 0;
                const mfr = row.querySelector('.mfr-code').value.trim();
                const hsn = row.querySelector('.hsn-code').value.trim();
                const batch = row.querySelector('.batch-no').value.trim();
                const expiry = row.querySelector('.expiry').value.trim();

                if (!medicineName || qty <= 0 || rate <= 0) {
                    allFieldsFilled = false;
                    return;
                }

                const amountBeforeGST = (qty * rate) - disc;
                const gstAmount = amountBeforeGST * (gst / 100);
                const cgst = gstAmount / 2;
                const sgst = gstAmount / 2;
                const igst = 0;

                items.push({
                    medicineName, qty, rate, disc, gst, amount, mfr, hsn, batch, expiry, cgst, sgst, igst
                });
            });

            if (!vendorName || !purchaseInvoice || items.length === 0 || !allFieldsFilled) {
                showMessage('Validation Error', 'Please fill in vendor details, invoice number, and all medicine details correctly.');
                return;
            }

            const purchaseData = {
                vendorName, vendorAddress, invoiceNo: purchaseInvoice, date: purchaseDate, time: purchaseTime, paymentTerms, items
            };

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showMessage('Success', response.message);
                        resetPurchaseForm();
                    } else {
                        showMessage('Error', response.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('Error', 'Failed to save purchase data: ' + error.message);
                })
                .savePurchaseData(purchaseData);
        }

        function printAndSaveSales() {
            saveSales(); // Save first
            window.print(); // Then print
        }

        function printAndSavePurchase() {
            savePurchase(); // Save first
            window.print(); // Then print
        }

        function resetInvoiceForm() {
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-address').value = '';
            // Reset medicine table to initial state (e.g., 2 empty rows)
            const tbody = document.getElementById('medicine-table-body');
            tbody.innerHTML = ''; // Clear all rows
            addNewRow(); // Add first empty row
            addNewRow(); // Add second empty row
            calculateTotals();
        }

        function resetPurchaseForm() {
            document.getElementById('vendor-name').value = '';
            document.getElementById('vendor-gstin').value = '';
            document.getElementById('vendor-address').value = '';
            document.getElementById('purchase-invoice').value = '';
            document.getElementById('payment-terms').selectedIndex = 0;
            // Reset medicine table
            const tbody = document.getElementById('purchase-table-body');
            tbody.innerHTML = '';
            addPurchaseRow(); // Add first empty row
        }

        function generateReport() {
            const reportType = document.querySelector('input[name="report-type"]:checked').value;
            const fromDate = document.getElementById('report-from').value;
            const toDate = document.getElementById('report-to').value;
            const stockDate = document.getElementById('report-stock-date').value;

            let actualFromDate = null;
            let actualToDate = null;

            if (reportType === 'stock') {
                actualToDate = stockDate; // For stock, 'to' date is 'as of date'
            } else {
                actualFromDate = fromDate;
                actualToDate = toDate;
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.error) {
                        showMessage('Report Error', response.error);
                        document.getElementById('report-body').innerHTML = '';
                        document.getElementById('report-head').innerHTML = '';
                        document.getElementById('report-total-value').textContent = `Total Value: ₹0.00`;
                    } else {
                        loadReportData(reportType, response.data, response.headers, response.totalValue);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('Error', 'Failed to fetch report data: ' + error.message);
                })
                .getReportData(reportType, actualFromDate, actualToDate);
        }
        
        function loadReportData(type, data, headers, totalValue) {
            const tbody = document.getElementById('report-body');
            const reportHead = document.getElementById('report-head');
            
            // Clear existing data
            tbody.innerHTML = '';
            
            // Set table headers
            let headHtml = '';
            headers.forEach(header => {
                headHtml += `<th>${header}</th>`;
            });
            reportHead.innerHTML = headHtml;
            
            // Populate table
            data.forEach(item => {
                const row = document.createElement('tr');
                if (type === 'sales' || type === 'purchases') {
                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.invoice}</td>
                        <td>${item.name}</td>
                        <td>${item.medicine}</td>
                        <td>${item.batch}</td>
                        <td>${item.qty}</td>
                        <td>${item.rate}</td>
                        <td>${item.amount}</td>
                        <td>${item.gst}</td>
                    `;
                } else if (type === 'stock') {
                    row.innerHTML = `
                        <td>${item.medicine}</td>
                        <td>${item.batch}</td>
                        <td>${item.expiry}</td>
                        <td>${item.qty}</td>
                        <td>${item.rate}</td>
                        <td>${item.amount}</td>
                    `;
                }
                tbody.appendChild(row);
            });
            
            // Display total value
            document.getElementById('report-total-value').textContent = `Total Value: ₹${totalValue}`;
        }
        
        function printReport() {
            showMessage('Print Report', `Printing ${document.querySelector('input[name="report-type"]:checked').value} report...`, 'alert', () => {
                window.print();
            });
        }
        
        function exportToCSV() {
            showMessage('Export to CSV', `Exporting ${document.querySelector('input[name="report-type"]:checked').value} report to CSV...`);
            // In a real app, you'd fetch the data and format it as CSV
            // For now, this is a placeholder.
        }

        // Data Management Functions
        function confirmDeleteByInvoice() {
            const type = document.getElementById('delete-transaction-type').value;
            const invoiceNumber = document.getElementById('delete-invoice-number').value.trim();
            
            if (!invoiceNumber) {
                showMessage('Input Required', 'Please enter an invoice number');
                return;
            }
            
            showMessage('Confirm Deletion', `Are you sure you want to delete this ${type === 'sale' ? 'sale' : 'purchase'} invoice (${invoiceNumber})? This action cannot be undone.`, 'confirm', (confirmed) => {
                if (confirmed) {
                    google.script.run
                        .withSuccessHandler(function(response) {
                            if (response.success) {
                                showMessage('Success', response.message);
                                document.getElementById('delete-invoice-number').value = '';
                            } else {
                                showMessage('Error', response.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            showMessage('Error', 'Failed to delete invoice: ' + error.message);
                        })
                        .deleteByInvoice(type, invoiceNumber);
                }
            });
        }

        function confirmDeleteByDateRange() {
            const type = document.getElementById('delete-date-type').value;
            const fromDate = document.getElementById('delete-from-date').value;
            const toDate = document.getElementById('delete-to-date').value;
            
            if (!fromDate || !toDate) {
                showMessage('Input Required', 'Please select both start and end dates');
                return;
            }
            
            let typeText = '';
            if (type === 'sale') typeText = 'sales';
            else if (type === 'purchase') typeText = 'purchases';
            else typeText = 'sales and purchases';
            
            showMessage('Confirm Deletion', `Are you sure you want to delete all ${typeText} transactions between ${fromDate} and ${toDate}? This action cannot be undone.`, 'confirm', (confirmed) => {
                if (confirmed) {
                    google.script.run
                        .withSuccessHandler(function(response) {
                            if (response.success) {
                                showMessage('Success', response.message);
                            } else {
                                showMessage('Error', response.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            showMessage('Error', 'Failed to delete transactions by date range: ' + error.message);
                        })
                        .deleteByDateRange(type, fromDate, toDate);
                }
            });
        }

        function confirmDeleteAll() {
            const password = document.getElementById('admin-password').value;
            
            if (!password) {
                showMessage('Input Required', 'Please enter the admin password');
                return;
            }
            
            // In a real app, you would verify the password first
            showMessage('WARNING', 'This will permanently delete ALL transaction data. Are you absolutely sure?', 'confirm', (confirmed1) => {
                if (confirmed1) {
                    showMessage('LAST CHANCE', 'This is your last chance to cancel. All data will be lost. Proceed?', 'confirm', (confirmed2) => {
                        if (confirmed2) {
                            // In a real app, this would call your backend to delete all data
                            // For now, we'll just simulate success
                            google.script.run
                                .withSuccessHandler(function(response) {
                                    if (response.success) {
                                        showMessage('Success', response.message);
                                        document.getElementById('admin-password').value = '';
                                    } else {
                                        showMessage('Error', response.message);
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    showMessage('Error', 'Failed to delete all data: ' + error.message);
                                })
                                .deleteAllData();
                        }
                    });
                }
            });
        }

        function createBackupFile() {
            showMessage('Creating Backup', 'Generating backup file...', 'alert'); // Show loading message
            google.script.run
                .withSuccessHandler(function(backupJsonString) {
                    const blob = new Blob([backupJsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ganesh_billing_backup_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Backup Success', 'Backup file has been downloaded.');
                })
                .withFailureHandler(function(error) {
                    showMessage('Error', 'Failed to create backup: ' + error.message);
                })
                .createBackup();
        }

        function restoreBackupFile() {
            const fileInput = document.getElementById('backup-file');
            
            if (!fileInput.files.length) {
                showMessage('Input Required', 'Please select a backup file to restore');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const backupJsonString = e.target.result;
                showMessage('Confirm Restore', 'Restoring from backup will overwrite your current data. Continue?', 'confirm', (confirmed) => {
                    if (confirmed) {
                        showMessage('Restoring Data', 'Restoring data from backup...', 'alert'); // Show loading message
                        google.script.run
                            .withSuccessHandler(function(response) {
                                if (response.success) {
                                    showMessage('Restore Success', response.message);
                                    fileInput.value = ''; // Clear file input
                                    // Optionally refresh the current page to reflect restored data
                                    // location.reload();
                                } else {
                                    showMessage('Error', response.message);
                                }
                            })
                            .withFailureHandler(function(error) {
                                showMessage('Error', 'Failed to restore backup: ' + error.message);
                            })
                            .restoreBackup(backupJsonString);
                    }
                });
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
